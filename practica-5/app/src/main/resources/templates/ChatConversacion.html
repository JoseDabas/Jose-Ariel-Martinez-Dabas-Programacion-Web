<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${titulo}">Conversación de Chat</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f4f4f4;
      }
      .container {
        max-width: 1000px;
        margin: 50px auto;
      }
      .card {
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .chat-messages {
        height: 500px;
        overflow-y: auto;
        padding: 20px;
      }
      .message {
        margin-bottom: 15px;
        max-width: 80%;
      }
      .message-admin {
        align-self: flex-end;
        margin-left: auto;
        background-color: #333333;
        color: white;
      }
      .message-visitor {
        align-self: flex-start;
        background-color: #f1f1f1;
      }
      .message-content {
        padding: 10px 15px;
        border-radius: 10px;
      }
      .message-sender {
        font-weight: bold;
        margin-bottom: 5px;
      }
      .btn-primary {
        background-color: #333333;
        border: none;
      }
      .btn-primary:hover {
        background-color: #555555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 class="mb-4 text-center">
        <b
          >Conversación con
          <span
            th:text="${nombreVisitante != null ? nombreVisitante : 'Visitante'}"
            >Visitante</span
          >
        </b>
      </h2>

      <div class="card">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">
            ID de Sesión: <span th:text="${sessionId}">session-id</span>
          </h5>
          <a href="/admin/chats" class="btn btn-sm btn-outline-secondary"
            >Volver a la lista</a
          >
        </div>

        <div class="card-body chat-messages" id="chat-messages">
          <div th:if="${mensajes.empty}" class="text-center py-4">
            <p>No hay mensajes en esta conversación.</p>
          </div>

          <div th:each="mensaje : ${mensajes}" class="d-flex">
            <div
              th:class="'message ' + (${mensaje.esAdministrador} ? 'message-admin' : 'message-visitor')"
            >
              <div class="message-content">
                <div
                  class="message-sender"
                  th:text="${mensaje.esAdministrador ? 'Tú' : mensaje.nombreVisitante}"
                >
                  Sender
                </div>
                <div class="message-text" th:text="${mensaje.mensaje}">
                  Message
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <div class="input-group">
            <input
              type="text"
              id="message-input"
              class="form-control"
              placeholder="Escribe un mensaje..."
            />
            <div class="input-group-append">
              <button id="send-message" class="btn btn-primary">Enviar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const chatMessages = document.getElementById("chat-messages");
        const chatMessageInput = document.getElementById("message-input");
        const sendMessageBtn = document.getElementById("send-message");

        let ws;
        const sessionId = "[[${sessionId}]]";
        const adminUsername = "[[${admin != null ? admin.username : ''}]]";

        console.log("ID de sesión:", sessionId);
        console.log("Admin username:", adminUsername);

        // Scroll al final de los mensajes
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Inicializar WebSocket
        initWebSocket();

        // Enviar mensaje
        sendMessageBtn.addEventListener("click", sendMessage);
        chatMessageInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            sendMessage();
          }
        });

        function sendMessage() {
          const message = chatMessageInput.value.trim();

          console.log("Intentando enviar mensaje:", message);
          console.log(
            "Estado WebSocket:",
            ws ? ws.readyState : "no inicializado"
          );

          if (message && ws && ws.readyState === WebSocket.OPEN) {
            const chatMessage = {
              type: "chat",
              sessionId: sessionId,
              adminUsername: adminUsername,
              visitorName:
                "[[${nombreVisitante != null ? nombreVisitante : 'Visitante'}]]",
              message: message,
              isAdmin: true,
              timestamp: new Date().toISOString(),
            };

            console.log("Enviando mensaje:", chatMessage);
            ws.send(JSON.stringify(chatMessage));
            appendMessage("Tú", message, true);
            chatMessageInput.value = "";
          } else {
            console.error(
              "No se puede enviar el mensaje. WebSocket no está abierto."
            );
            if (!ws) {
              console.error("WebSocket no inicializado");
            } else {
              console.error("Estado WebSocket:", ws.readyState);
            }

            // Reintentar conexión si está cerrada
            if (!ws || ws.readyState !== WebSocket.OPEN) {
              console.log("Reintentando conexión WebSocket...");
              initWebSocket();
            }
          }
        }

        function initWebSocket() {
          const protocol =
            window.location.protocol === "https:" ? "wss:" : "ws:";
          const wsUrl = `${protocol}//${window.location.host}/chat`;

          console.log("Inicializando WebSocket:", wsUrl);
          ws = new WebSocket(wsUrl);

          ws.onopen = function () {
            console.log("WebSocket conectado");

            // Registrar como administrador
            if (adminUsername) {
              const registerMessage = {
                type: "register",
                username: adminUsername,
                isAdmin: true,
              };

              console.log("Registrando administrador:", registerMessage);
              ws.send(JSON.stringify(registerMessage));
            } else {
              console.error(
                "No hay nombre de usuario de administrador disponible"
              );
            }
          };

          ws.onmessage = function (event) {
            console.log("Mensaje recibido:", event.data);
            try {
              const message = JSON.parse(event.data);

              if (
                message.type === "chat" &&
                !message.isAdmin &&
                message.sessionId === sessionId
              ) {
                appendMessage(message.visitorName, message.message, false);
              }
            } catch (e) {
              console.error("Error procesando mensaje:", e);
            }
          };

          ws.onclose = function (event) {
            console.log(
              "WebSocket desconectado. Código:",
              event.code,
              "Razón:",
              event.reason
            );

            // Reconectar después de un tiempo
            setTimeout(function () {
              console.log("Reintentando conexión...");
              initWebSocket();
            }, 3000);
          };

          ws.onerror = function (error) {
            console.error("Error de WebSocket:", error);
          };
        }

        function appendMessage(sender, message, isAdmin) {
          const messageDiv = document.createElement("div");
          messageDiv.className = `d-flex ${
            isAdmin ? "justify-content-end" : "justify-content-start"
          }`;

          messageDiv.innerHTML = `
                    <div class="message ${
                      isAdmin ? "message-admin" : "message-visitor"
                    } mb-2">
                        <div class="message-content">
                            <div class="message-sender font-weight-bold">${sender}</div>
                            <div class="message-text">${message}</div>
                        </div>
                    </div>
                `;

          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      });
    </script>
  </body>
</html>
